<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Priority Inbox</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl-fast.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tweetnacl-util@0.15.1/nacl-util.min.js"></script>
</head>

<body class="bg-slate-50 text-slate-900">
    <div class="max-w-5xl mx-auto p-6">
        <header class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold">Priority Inbox</h1>
            <div class="flex items-center gap-2">
                <button id="btnHelp" class="px-3 py-2 rounded-xl border">Help</button>
                <button id="btnConnect" class="px-4 py-2 rounded-xl bg-black text-white">Connect Wallet</button>

                <div id="netStatus"
                    class="hidden text-xs bg-amber-100 text-amber-800 rounded-lg px-2 py-1 flex items-center gap-2">
                    <span>Wrong network. Please switch to <span id="netExpected" class="font-medium">—</span>.</span>
                    <button id="btnSwitchNetwork" class="px-2 py-1 rounded border">Switch</button>
                </div>
            </div>
        </header>

        <div class="mb-4 flex gap-2">
            <button id="tabUser" class="px-3 py-2 rounded-lg bg-white shadow">Sender</button>
            <button id="tabLeader" class="px-3 py-2 rounded-lg">Receiver</button>
        </div>

        <section id="leaderView" class="hidden grid gap-6">
            <div class="bg-white rounded-2xl shadow p-5">
                <h2 class="font-semibold mb-3">Register / Keys</h2>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm mb-1">Active Public Key (bytes32 hex)</label>
                        <input id="activePubKey" class="w-full border rounded-xl p-2" readonly />
                        <div class="mt-3 flex gap-2">
                            <button id="btnGenRegister" class="px-3 py-2 rounded-lg bg-indigo-600 text-white">Generate &
                                Register</button>
                            <button id="btnRotate" class="px-3 py-2 rounded-lg bg-indigo-600 text-white">Rotate
                                Key</button>
                            <button id="btnCopyPub" class="px-3 py-2 rounded-lg border">Copy</button>
                        </div>
                        <div class="mt-2 flex gap-2">
                            <button id="btnExportPriv" class="px-3 py-2 rounded-lg border">Export Private Key</button>
                            <label class="px-3 py-2 rounded-lg border cursor-pointer">
                                Import Private Key<input id="fileImportPriv" type="file" accept=".key,.txt"
                                    class="hidden" />
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm mb-1">Legacy Key (add/remove)</label>
                        <input id="legacyKey" class="w-full border rounded-xl p-2" placeholder="0x…" />
                        <div class="mt-3 flex gap-2">
                            <button id="btnAddLegacy" class="px-3 py-2 rounded-lg border">Add Legacy</button>
                            <button id="btnRemoveLegacy" class="px-3 py-2 rounded-lg border">Remove Legacy</button>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">Allowed keys define what senders may use to encrypt.</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow p-5">
                <h2 class="font-semibold mb-4">Your Queue</h2>
                <div id="leaderList" class="grid gap-3"></div>
            </div>

            <div class="bg-white rounded-2xl shadow p-5">
                <h2 class="font-semibold mb-3">Withdraw</h2>
                <div id="leaderBalances" class="text-sm text-slate-600 mb-3"></div>

                <div class="grid md:grid-cols-3 gap-3">
                    <input id="wdAmount" class="border rounded-xl p-2" placeholder="Amount (raw units)" />
                    <input id="wdTo" class="border rounded-xl p-2" placeholder="Recipient (optional)" />
                </div>
                <button id="btnWithdraw" class="mt-3 px-3 py-2 rounded-lg bg-black text-white">Withdraw</button>
            </div>
        </section>

        <section id="userView" class="grid gap-6">
            <div class="bg-white rounded-2xl shadow p-5">
                <h2 class="font-semibold mb-3">Lookup Receiver</h2>
                <div class="grid md:grid-cols-3 gap-3">
                    <input id="inpLeaderAddr" class="border rounded-xl p-2" placeholder="Leader address (0x…)" />
                    <button id="btnLookup" class="px-3 py-2 rounded-lg bg-black text-white">Load</button>
                    <div id="leaderInfo" class="text-xs self-center bg-slate-100 rounded p-2 font-mono w-full truncate"
                        title=""></div>
                </div>
                <div class="mt-4">
                    <h3 class="font-medium mb-2">Top messages (encrypted)</h3>
                    <div id="publicTop" class="grid gap-2"></div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow p-5">
                <h2 class="font-semibold mb-3">Send a Message</h2>
                <div class="grid md:grid-cols-2 gap-3">
                    <textarea id="msgBody" class="border rounded-xl p-2 h-28"
                        placeholder="Write your message…"></textarea>
                    <div class="grid gap-3">
                        <div class="grid grid-cols-3 gap-3">
                            <div class="md:col-span-1">
                                <label class="block text-sm mb-1">Token</label>
                                <div id="feeTokenName" class="border rounded-xl p-2 bg-slate-100 select-text">—</div>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm mb-1">Token Address</label>
                                <div id="feeTokenAddr"
                                    class="border rounded-xl p-2 bg-slate-100 font-mono select-text w-full truncate">
                                    —</div>
                            </div>
                        </div>
                        <input id="feeAmount" class="border rounded-xl p-2" placeholder="Amount (e.g., 1.5)" />
                        <div id="userBalance" class="text-xs text-slate-500">Balance: —</div>

                        <button id="btnSend" class="px-3 py-2 rounded-lg bg-indigo-600 text-white">Approve &
                            Send</button>
                        <div id="sendStatus" class="text-sm text-slate-500"></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow p-5">
                <h2 class="font-semibold mb-3">Your Past Messages</h2>
                <div id="userMsgs" class="grid gap-2"></div>
            </div>
        </section>
    </div>


    // <!-- Help overlay -->
    <div id="helpOverlay" class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm">
        <div class="min-h-full flex items-start md:items-center justify-center p-4">
            <div id="helpPanel" class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">How this works</h2>
                    <button id="helpClose" class="px-2 py-1 rounded-lg border text-sm">Close</button>
                </div>
                <div class="space-y-4 text-sm">
                    <div>
                        <h3 class="font-medium mb-1">For Regular Users</h3>
                        <ol class="list-decimal pl-5 space-y-1">
                            <li>Paste a receiver address (or open with <span class="font-mono">?receiver=0x…</span>) and
                                click <b>Load</b>.</li>
                            <li>Connect your wallet (optional) to see your past messages and queue position.</li>
                            <li>Write your message. Choose an ERC-20 fee amount; higher fee ranks higher.</li>
                            <li>Click <b>Approve &amp; Send</b>. The message is encrypted in your browser.</li>
                        </ol>
                    </div>
                    <div>
                        <h3 class="font-medium mb-1">For Receivers</h3>
                        <ol class="list-decimal pl-5 space-y-1">
                            <li>Connect wallet and click <b>Generate &amp; Register</b> to create an encryption keypair.
                            </li>
                            <li><b>Export</b> your private key and store it safely. The public key is on-chain.</li>
                            <li>Queue is sorted by fee → time. Click <b>Mark Read</b> to enable decryption, then decrypt
                                and optionally <b>Mark Completed</b>.</li>
                            <li>Use <b>Rotate Key</b> to change keys; old messages can be decrypted if you kept the old
                                private key.</li>
                        </ol>
                    </div>
                    <p class="text-xs text-slate-500">Tip: You can deep link to a receiver with <span
                            class="font-mono">?receiver=0xABC…</span>. Press <kbd class="border px-1 rounded">Esc</kbd>
                        to
                        close this help.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ====== CONFIG ======
        const CONTRACT_ADDRESS = "0x0165878A594ca255338adfa4d48449f69242Eb8F"; // <- replace after deploy
        // Network config (hardcode your target network here)
        const MAINNET_CHAIN_ID = '0x144'; // 0x144 = 324 (Matter mainnet), 0x7a69 - local testnet
        const MAINNET_CHAIN_PARAMS = {
            chainId: MAINNET_CHAIN_ID,
            chainName: 'Zksync Era Mainnet',
            nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
            rpcUrls: ['https://mainnet.era.zksync.io'],
            blockExplorerUrls: ['https://explorer.zksync.io/']
        };

        const LOCAL_CHAIN_ID = '0x7a69'; // 0x144 = 324 (Matter mainnet), 0x7a69 - local testnet
        const LOCAL_CHAIN_PARAMS = {
            chainId: LOCAL_CHAIN_ID,
            chainName: 'Local Testnet',
            nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
            rpcUrls: ['http://localhost:8545'],
            blockExplorerUrls: []
        };


        //const TARGET_CHAIN_ID = MAINNET_CHAIN_ID;
        //const TARGET_CHAIN_PARAMS = MAINNET_CHAIN_PARAMS;
        const TARGET_CHAIN_ID = LOCAL_CHAIN_ID;
        const TARGET_CHAIN_PARAMS = LOCAL_CHAIN_PARAMS;


        const ABI = [
            // views
            "function version() view returns(string)",
            "function getLeader(address) view returns (bool, bytes32)",
            "function getLeaderKeys(address) view returns (bytes32[] memory, bool[] memory)",
            "function leaderMessageIds(address) view returns (uint256[] memory)",
            "function senderMessageIds(address) view returns (uint256[] memory)",
            "function balances(address,address) view returns (uint256)",
            "function acceptedToken() view returns (address)",
            // messages[] public getter
            "function messages(uint256) view returns (address sender, address leader, uint256 amount, uint64 timestamp, uint8 status, bytes32 pubkeyUsed, bytes data)",
            // writes
            "function registerLeader(bytes32)",
            "function setActiveKey(bytes32)",
            "function addLegacyKey(bytes32)",
            "function removeLegacyKey(bytes32)",
            "function sendMessage(address,uint256,bytes32,bytes) returns (uint256)",
            "function markAsRead(uint256)",
            "function markAsCompleted(uint256)",
            "function withdraw(address,uint256)"
        ];

        const ERC20_ABI = [
            "function decimals() view returns (uint8)",
            "function allowance(address,address) view returns (uint256)",
            "function approve(address,uint256) returns (bool)",
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function balanceOf(address) view returns (uint256)",

        ];

        // ====== ETH setup ======
        let provider, signer, me, contract, tokenAddress, tokenName, tokenSymbol, tokenDecimals;


        async function connect() {
            if (!window.ethereum) { alert("Please install a wallet like MetaMask."); return; }
            await ethereum.request({ method: 'eth_requestAccounts' });
            const ok = await ensureCorrectNetwork();
            if (!ok) { document.getElementById('btnConnect').textContent = 'Wrong network'; return; }

            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            me = await signer.getAddress();
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            tokenAddress = await contract.acceptedToken();
            const erc = new ethers.Contract(tokenAddress, ERC20_ABI, provider);
            tokenName = await erc.name();
            tokenSymbol = await erc.symbol();
            tokenDecimals = await erc.decimals();

            document.getElementById('btnConnect').textContent = me.slice(0, 6) + "…" + me.slice(-4);
            refreshLeaderUI();
        }
        // Attempt silent reconnect on page load (no popups) if the site is already authorized
        async function silentConnect() {
            if (!window.ethereum) return;
            const accounts = await ethereum.request({ method: 'eth_accounts' });
            if (!accounts || accounts.length === 0) return;
            const ok = await ensureCorrectNetwork();
            if (!ok) { document.getElementById('btnConnect').textContent = 'Wrong network'; return; }

            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            me = accounts[0];
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            tokenAddress = await contract.acceptedToken();
            const erc = new ethers.Contract(tokenAddress, ERC20_ABI, provider);
            tokenName = await erc.name();
            tokenSymbol = await erc.symbol();
            tokenDecimals = await erc.decimals();

            document.getElementById('btnConnect').textContent = me.slice(0, 6) + "…" + me.slice(-4);
            refreshLeaderUI();
        }

        // ====== UI helpers ======
        function hexToUint8(hex) {
            hex = hex.replace(/^0x/, '');
            const bytes = new Uint8Array(hex.length / 2);
            for (let i = 0; i < bytes.length; i++) bytes[i] = parseInt(hex.substr(i * 2, 2), 16);
            return bytes;
        }
        function uint8ToHex(arr) {
            return '0x' + Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
        }
        function download(name, content) {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([content], { type: 'text/plain' }));
            a.download = name; a.click();
        }


        // ====== Network helpers ======
        async function ensureCorrectNetwork() {
            if (!window.ethereum) return false;
            const current = await ethereum.request({ method: 'eth_chainId' });
            document.getElementById('netExpected').textContent = TARGET_CHAIN_PARAMS.chainName || TARGET_CHAIN_ID;
            const mismatch = current !== TARGET_CHAIN_ID;
            document.getElementById('netStatus').classList.toggle('hidden', !mismatch);
            return !mismatch;
        }
        async function switchToTarget() {
            try {
                await ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: TARGET_CHAIN_ID }] });
            } catch (e) {
                // Unrecognized chain -> try adding it
                if (e && e.code === 4902) {
                    await ethereum.request({ method: 'wallet_addEthereumChain', params: [TARGET_CHAIN_PARAMS] });
                } else {
                    throw e;
                }
            }
        }

        // URL param helpers
        function setQueryParam(key, value) {
            const url = new URL(window.location.href);
            if (value) url.searchParams.set(key, value);
            else url.searchParams.delete(key);
            history.replaceState(null, '', url);
        }

        // ====== Key mgmt (NaCl) ======
        function generateKeypair() { return nacl.box.keyPair(); }
        function storeLeaderPriv(address, pubHex, privHex) {
            localStorage.setItem(`leaderPriv:${address.toLowerCase()}:${pubHex.toLowerCase()}`, privHex);
        }
        function loadLeaderPriv(address, pubHex) {
            return localStorage.getItem(`leaderPriv:${address.toLowerCase()}:${pubHex.toLowerCase()}`);
        }

        function encryptForLeader(messageUTF8, leaderPubHex) {
            const leaderPub = hexToUint8(leaderPubHex);
            const eph = generateKeypair();
            const nonce = nacl.randomBytes(24);
            const msgBytes = nacl.util.decodeUTF8(messageUTF8);
            const boxed = nacl.box(msgBytes, nonce, leaderPub, eph.secretKey);
            const payload = new Uint8Array(32 + 24 + boxed.length);
            payload.set(eph.publicKey, 0);
            payload.set(nonce, 32);
            payload.set(boxed, 56);
            return uint8ToHex(payload);
        }
        function decryptWithPriv(payloadHex, myPrivHex) {
            const all = hexToUint8(payloadHex);
            const ephPub = all.slice(0, 32);
            const nonce = all.slice(32, 56);
            const boxed = all.slice(56);
            const myPriv = hexToUint8(myPrivHex);
            const opened = nacl.box.open(boxed, nonce, ephPub, myPriv);
            if (!opened) throw new Error('Decryption failed');
            return nacl.util.encodeUTF8(opened);
        }

        // ====== Sorting ======
        function sortMsgs(arr) {
            return arr.sort((A, B) => {
                if (A.amount.gt(B.amount)) return -1;
                if (A.amount.lt(B.amount)) return 1;
                return Number(A.timestamp) - Number(B.timestamp);
            });
        }

        // ====== Leadership view ======
        async function refreshLeaderUI() {
            if (!contract || !me) return;
            document.getElementById('feeTokenName').textContent = tokenName;
            document.getElementById('feeTokenAddr').textContent = tokenAddress;

            //document.getElementById('wdToken').value = token;
            //document.getElementById('wdToken').placeholder = `${name} (${symbol})`;
            const [isLeader, activeKey] = await contract.getLeader(me);
            document.getElementById('activePubKey').value = activeKey && activeKey !== ethers.constants.HashZero ? activeKey : '';
            await loadLeaderQueue(me);
            await refreshUserBalance();
        }

        async function loadLeaderQueue(addr) {
            const ids = await contract.leaderMessageIds(addr);
            const msgs = [];
            for (const id of ids) {
                const m = await contract.messages(id);
                msgs.push({ id: id.toNumber(), sender: m.sender, amount: m.amount, timestamp: m.timestamp, status: m.status, pubkeyUsed: m.pubkeyUsed, data: m.data });
            }
            //sortMsgs(msgs);
            // hide completed (Status.Completed === 2)
            const queue = msgs.filter(m => Number(m.status) !== 2);
            sortMsgs(queue);


            const list = document.getElementById('leaderList');
            list.innerHTML = '';
            for (const m of queue) {
                const card = document.createElement('div');
                card.className = 'border rounded-xl p-3 flex items-start justify-between gap-3';
                const left = document.createElement('div');
                const canDecrypt = Number(m.status) === 1; // only when Read

                left.innerHTML = `<div class="text-sm">From <span class="font-mono">${m.sender.slice(0, 6)}…${m.sender.slice(-4)}</span></div>
      <div class="text-xs text-slate-600">Amount: ${ethers.utils.formatUnits(m.amount, tokenDecimals)} ${tokenSymbol} | Time: ${new Date(Number(m.timestamp) * 1000).toLocaleString()}</div >
                <details class="mt-2">
                    <summary class="cursor-pointer text-sm">Open</summary>
                    <div class="mb-2">
                        ${canDecrypt
                        ? '<button class="border px-2 py-1 rounded" data-act="decrypt">Decrypt</button> <span class="ml-2 text-slate-500" data-bind="out"></span>'
                        : '<span class="text-xs text-slate-500">Mark as <b>Read</b> first to enable decryption.</span>'}
                        <div class="font-mono text-xs break-all">${m.data}</div>
                    </div>
                </details>`;
                const right = document.createElement('div');
                const showReadBtn = Number(m.status) === 0; // only when New
                const showDoneBtn = Number(m.status) === 1; // only show "Completed" after it's Read

                right.innerHTML = `<div class="flex gap-2" >
                    ${showReadBtn ? '<button class="px-2 py-1 rounded bg-amber-500 text-white" data-act="read">Mark Read</button>' : ''}
                    ${showDoneBtn ? '<button class="px-2 py-1 rounded bg-emerald-600 text-white" data-act="done">Mark Completed</button>' : ''}
    </div >
                <div class="text-xs mt-1 text-slate-600">Status: ${['New', 'Read', 'Completed'][m.status]}</div>`;
                card.appendChild(left); card.appendChild(right);
                list.appendChild(card);

                const decBtn = card.querySelector('[data-act="decrypt"]');
                if (decBtn) {
                    decBtn.onclick = async () => {
                        try {
                            const activePub = document.getElementById('activePubKey').value;
                            let priv = loadLeaderPriv(me, activePub);
                            if (!priv) { alert('Import your private key first'); return; }
                            const text = decryptWithPriv(m.data, priv);
                            card.querySelector('[data-bind="out"]').textContent = text;
                        } catch (e) { alert(e.message || e); }
                    };
                }

                const readBtn = card.querySelector('[data-act="read"]');
                if (readBtn) {
                    readBtn.onclick = async () => { await (await contract.markAsRead(m.id)).wait(); refreshLeaderUI(); };
                }
                const doneBtn = card.querySelector('[data-act="done"]');
                if (doneBtn) {
                    doneBtn.onclick = async () => {
                        const ok = confirm('Are you sure you want to mark this message as Completed?');
                        if (!ok) return;
                        await (await contract.markAsCompleted(m.id)).wait();
                        refreshLeaderUI();
                    };
                }
            }

            // balances preview (simple: shows last token seen)
            const balDiv = document.getElementById('leaderBalances');
            const token = await contract.acceptedToken();
            const tokens = [token];

            const rows = await Promise.all(tokens.map(async t => {
                const v = await contract.balances(me, t);
                return `${tokenSymbol}: ${ethers.utils.formatUnits(v, tokenDecimals)} `;
            }));
            balDiv.textContent = `Escrow balances → ` + rows.join(' | ');
        }

        // Buttons
        const $ = s => document.getElementById(s);
        $('btnConnect').onclick = connect;

        $('btnSwitchNetwork').onclick = switchToTarget;

        // Auto-check network & react to changes
        if (window.ethereum) {
            ensureCorrectNetwork();
            ethereum.on('chainChanged', () => { location.reload(); });
            ethereum.on('accountsChanged', async (accs) => {
                // Refresh network indicator and UI when accounts change
                await ensureCorrectNetwork();
                if (!accs || !accs.length) {
                    provider = signer = contract = undefined; me = undefined;
                    $('btnConnect').textContent = 'Connect Wallet';
                }
            });
        }

        // Auto-detect connection on refresh and handle account/chain changes
        if (window.ethereum) {
            silentConnect();
            ethereum.on('accountsChanged', (accs) => {
                if (accs && accs.length) {
                    silentConnect();
                } else {
                    // disconnected
                    provider = undefined; signer = undefined; me = undefined; contract = undefined;
                    $('btnConnect').textContent = 'Connect Wallet';
                }
            });
            ethereum.on('chainChanged', () => {
                // ensure provider/contracts bind to the new network
                window.location.reload();
            });
        }

        $('feeAmount').addEventListener('focus', () => { refreshUserBalance(); });
        $('btnGenRegister').onclick = async () => {
            const kp = generateKeypair();
            const pubHex = uint8ToHex(kp.publicKey);
            const privHex = uint8ToHex(kp.secretKey);
            await (await contract.registerLeader(pubHex)).wait();
            storeLeaderPriv(me, pubHex, privHex);
            $('activePubKey').value = pubHex;
            alert('Registered. Private key saved in localStorage (and please export it).');
            refreshLeaderUI();
        };
        $('btnRotate').onclick = async () => {
            const kp = generateKeypair();
            const pubHex = uint8ToHex(kp.publicKey);
            const privHex = uint8ToHex(kp.secretKey);
            await (await contract.setActiveKey(pubHex)).wait();
            storeLeaderPriv(me, pubHex, privHex);
            $('activePubKey').value = pubHex;
            refreshLeaderUI();
        };
        $('btnCopyPub').onclick = () => {
            navigator.clipboard.writeText($('activePubKey').value);
        };
        $('btnExportPriv').onclick = () => {
            const pub = $('activePubKey').value; if (!pub) return alert('No active key');
            const priv = loadLeaderPriv(me, pub);
            if (!priv) return alert('Private key not found in localStorage for this pubkey');
            download(`leader-${me.slice(0, 6)}-${pub.slice(2, 10)}.key`, priv);
        };
        $('fileImportPriv').onchange = async (e) => {
            const file = e.target.files[0]; if (!file) return;
            const text = await file.text();
            const pub = $('activePubKey').value; if (!pub) return alert('Import after you have an active key');
            storeLeaderPriv(me, pub, text.trim());
            alert('Private key imported for active pubkey.');
        };
        $('btnAddLegacy').onclick = async () => {
            const k = $('legacyKey').value.trim(); if (!k) return;
            await (await contract.addLegacyKey(k)).wait();
            alert('Legacy key added.');
        };
        $('btnRemoveLegacy').onclick = async () => {
            const k = $('legacyKey').value.trim(); if (!k) return;
            await (await contract.removeLegacyKey(k)).wait();
            alert('Legacy key removed.');
        };
        $('btnWithdraw').onclick = async () => {
            const amt = $('wdAmount').value.trim();
            const to = $('wdTo').value.trim() || me;
            await (await contract.withdraw(to, ethers.BigNumber.from(amt))).wait();
            alert('Withdrawn.');
            refreshLeaderUI();
        };

        // ====== User view ======
        $('tabLeader').onclick = () => { $('leaderView').classList.remove('hidden'); $('userView').classList.add('hidden'); $('tabLeader').classList.add('bg-white', 'shadow'); $('tabUser').classList.remove('bg-white', 'shadow'); };
        $('tabUser').onclick = () => { $('leaderView').classList.add('hidden'); $('userView').classList.remove('hidden'); $('tabUser').classList.add('bg-white', 'shadow'); $('tabLeader').classList.remove('bg-white', 'shadow'); };

        $('btnLookup').onclick = async () => {
            if (!provider) provider = new ethers.providers.Web3Provider(window.ethereum || window);
            const read = contract || new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
            const leaderAddr = $('inpLeaderAddr').value.trim();
            // keep URL in sync for deep links
            setQueryParam('receiver', leaderAddr);
            const [isLeader, activeKey] = await read.getLeader(leaderAddr);
            $('leaderInfo').textContent = isLeader ? `Active key: ${activeKey} ` : 'Account NOT registered as receiver';
            const ids = await read.leaderMessageIds(leaderAddr);
            const msgs = [];

            for (const id of ids) {
                const m = await read.messages(id);
                msgs.push({ id: id.toNumber(), token: m.token, amount: m.amount, timestamp: m.timestamp, status: m.status, sender: m.sender });
            }
            // Exclude Completed (status === 2) from public top list
            const visible = msgs.filter(m => Number(m.status) !== 2);
            sortMsgs(visible);
            const top = visible.slice(0, 10);


            const box = $('publicTop'); box.innerHTML = '';
            let index = 0;
            for (const m of top) {
                const row = document.createElement('div');
                row.className = 'border rounded-xl p-3 text-sm flex justify-between';
                //row.innerHTML = `<span> ${new Date(Number(m.timestamp) * 1000).toLocaleString()}</span > <span class="font-mono">${m.amount.toString()}</span>`;
                const ts = new Date(Number(m.timestamp) * 1000).toLocaleString();
                const statusChip = (Number(m.status) === 1)
                    ? `<span class="ml-2 px-2 py-0.5 rounded text-xs bg-amber-100 text-amber-700 align-middle">Read</span>`
                    : '';
                const mineChip = (me && m.sender && m.sender.toLowerCase() === me.toLowerCase())
                    ? `<span class="ml-2 px-2 py-0.5 rounded text-xs bg-emerald-100 text-emerald-700 align-middle">Yours</span>`
                    : '';
                index += 1;
                const posChip = `<span class="ml-2 px-2 py-0.5 rounded text-xs bg-slate-200 text-slate-700 align-middle" >#${index}</span>`;
                row.innerHTML = `<span>${posChip}: ${ts}${statusChip}${mineChip}</span><span class="font-mono">Fee: ${ethers.utils.formatUnits(m.amount, tokenDecimals)}</span>`;

                box.appendChild(row);
            }

            // If connected, show my messages & queue positions
            if (contract && me) {
                const mineIds = await read.senderMessageIds(me);
                const mine = [];
                for (const id of mineIds) { const m = await read.messages(id); mine.push({ id: id.toNumber(), amount: m.amount, timestamp: m.timestamp, status: m.status, leader: m.leader }); }
                sortMsgs(msgs);
                const sortedIds = msgs.map(x => x.id);
                const ui = $('userMsgs'); ui.innerHTML = '';
                for (const m of mine) {
                    const pos = sortedIds.indexOf(m.id) + 1; // 1-based
                    const row = document.createElement('div');
                    row.className = 'border rounded-xl p-3 text-sm flex justify-between';
                    row.innerHTML = `<span> ID #${m.id} — ${['New', 'Read', 'Completed'][m.status]}</span > <span>To: ${m.leader || '-'}</span>`;
                    ui.appendChild(row);
                }
            }
        };

        $('btnSend').onclick = async () => {
            if (!signer) return alert('Connect wallet first');
            const leaderAddr = $('inpLeaderAddr').value.trim();
            const [isLeader, activeKey] = await contract.getLeader(leaderAddr);
            if (!isLeader || activeKey === ethers.constants.HashZero) return alert('Leader not set or missing key');

            const token = $('feeTokenAddr').textContent.trim();
            const amountHuman = $('feeAmount').value.trim();
            const erc = new ethers.Contract(token, ERC20_ABI, signer);
            const amount = ethers.utils.parseUnits(amountHuman, tokenDecimals);

            $('sendStatus').textContent = 'Approving…';
            const allowance = await erc.allowance(me, CONTRACT_ADDRESS);
            if (allowance.lt(amount)) { await (await erc.approve(CONTRACT_ADDRESS, amount)).wait(); }

            $('sendStatus').textContent = 'Encrypting…';
            const cipherHex = encryptForLeader($('msgBody').value, activeKey);

            $('sendStatus').textContent = 'Sending…';
            const tx = await contract.sendMessage(leaderAddr, amount, activeKey, cipherHex);
            await tx.wait();
            $('sendStatus').textContent = 'Sent!';
        };
        // === Deep link: prefill & auto-load from ?leader=0x... ===
        (() => {
            const params = new URLSearchParams(window.location.search);
            const leaderFromURL = params.get('receiver');
            if (leaderFromURL) {
                $('tabUser').click();
                $('inpLeaderAddr').value = leaderFromURL.trim();
                $('btnLookup').click();
            }
        })();


        // === Balance helper ===
        async function refreshUserBalance() {
            const el = document.getElementById('userBalance');
            if (!el) return;
            const tokenAddr = document.getElementById('feeTokenAddr').textContent.trim();
            if (!me) { el.textContent = 'Balance: (connect wallet)'; return; }
            if (!ethers.utils.isAddress(tokenAddr)) { el.textContent = 'Balance: —'; return; }
            try {
                const erc = new ethers.Contract(tokenAddr, ERC20_ABI, signer || provider);
                const [dec, bal] = await Promise.all([erc.decimals(), erc.balanceOf(me)]);
                el.textContent = 'Balance: ' + ethers.utils.formatUnits(bal, dec);
            } catch (e) {
                el.textContent = 'Balance: —';
            }
        }


        // Help overlay controls
        function openHelp() { $('helpOverlay').classList.remove('hidden'); }
        function closeHelp() { $('helpOverlay').classList.add('hidden'); }
        if ($('btnHelp')) $('btnHelp').onclick = openHelp;
        if ($('helpClose')) $('helpClose').onclick = closeHelp;
        const _helpOverlayEl = document.getElementById('helpOverlay');
        if (_helpOverlayEl) {
            _helpOverlayEl.addEventListener('click', (e) => { if (e.target === _helpOverlayEl) closeHelp(); });
        }
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeHelp(); });
    </script>
</body>

</html>